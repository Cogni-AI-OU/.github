---
# See: <https://opencode.ai/docs/github/>
# Note: Keep keys and envs in alphabetical order.
name: OpenCode Review
on:
  issue_comment:
    types:
      - created
      - edited
  pull_request_review_comment:
    types:
      - created
      - edited
  pull_request_target:
    types:
      - opened
      - synchronize
      - ready_for_review
      - reopened
      - review_requested
    issue_comment:
      types:
        - created
  workflow_call:
    inputs:
      model:
        default: anthropic/claude-opus-4-5
        description: Claude model to use for review
        required: false
        type: string
  workflow_dispatch:
    inputs:
      model:
        default: anthropic/claude-opus-4-5
        description: Claude model to use for review
        options:
          - anthropic/claude-haiku-4-5
          - anthropic/claude-opus-4-5
          - anthropic/claude-sonnet-4-5
        required: false
        type: choice
jobs:
  review:
    # Run on pull_request events (skip bot-authored PRs except for ready_for_review),
    # workflow_call events, or workflow_dispatch events.
    # ready_for_review is allowed for bot PRs since it's explicitly triggered by a human user.
    # workflow_call and workflow_dispatch require pr_number input (marked as required).
    # Note: GitHub enforces the required: true constraint, so pr_number will always be
    # provided for workflow_dispatch; no additional null check is needed in this condition.
      if: |
        github.event_name == 'pull_request_target' || (
          github.event_name == 'issue_comment' &&
          github.event.issue.pull_request &&
          startsWith(github.event.comment.body, '/review') &&
          contains(fromJson('["OWNER","MEMBER"]'), github.event.comment.author_association)
        ) || (
          github.event_name == 'pull_request' && (
            github.event.pull_request.user.type != 'Bot' ||
            github.event.action == 'ready_for_review'
          )
        ) ||
        (github.event_name == 'workflow_call' || github.event_name == 'workflow_dispatch')
    name: OpenCode Review
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Get PR number
        id: pr-number
        run: |
          if [ "${{ github.event_name }}" = "pull_request_target" ]; then
            echo "number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
          else
            echo "number=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
          fi
      - name: Get PR details
        id: pr-details
        run: |
          gh api /repos/${{ github.repository }}/pulls/${{ steps.pr-number.outputs.number }} > pr_data.json
          echo "title=$(jq -r .title pr_data.json)" >> $GITHUB_OUTPUT
          echo "sha=$(jq -r .head.sha pr_data.json)" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - uses: actions/checkout@v6
        with:
          fetch-depth: 1
          persist-credentials: false
      - uses: anomalyco/opencode/github@latest
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OPENCODE_PERMISSION: '{ "bash": {  "*": "deny", "gh*": "allow", "gh pr review*": "deny" } }'
        with:
          # See: <https://opencode.ai/docs/models/>
          model: |
            ${{ (github.event_name == 'workflow_call' || github.event_name == 'workflow_dispatch')
            && inputs.model || 'anthropic/claude-opus-4-5' }}
          use_github_token: true
          prompt: |-
            Pull request needs to be reviewed in the context of the following repository:
            <repo>
            ${{ github.repository }}
            </repo>
            <pr-number>
            ${{ steps.pr-number.outputs.number }}
            </pr-number>
            <pr-title>
            ${{ steps.pr-details.outputs.title }}
            </pr-title>
            Review this pull request:
            - Check for code quality issues
            - In case the latest CI build fails, identify the main cause of failure.
            - Look for potential bugs, logic errors, or incorrect behavior
            - Missing error handling
            - Performance issues with measurable impact
            - Security vulnerabilities
            Guidelines:
            - Be concise. Only comment on high-value issues, not style preferences.
            - Skip praise, summaries, and obvious observations.
            - If no significant issues exist, state that briefly.
            - Reference AGENTS.md if present for project conventions.
            - Suggest committable improvements for simple fixes.
            - Use the gh cli to create comments on the files for the violations.
            - Generally, write a comment instead of writing suggested change if you can help it.
            Command MUST be like this.
            ```
            gh api \
              --method POST \
              -H "Accept: application/vnd.github+json" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              /repos/${{ github.repository }}/pulls/${{ steps.pr-number.outputs.number }}/comments \
              -f 'body=[summary of issue]' \
              -f 'commit_id=${{ steps.pr-details.outputs.sha }}' \
              -f 'path=[path-to-file]' \
              -f 'side=RIGHT' \
              -F "line=[line]"
            ```
      - name: Show OpenCode log on failure
        if: failure()
        run: |-
          tail -n 100 ~/.local/share/opencode/log/*.log 2>/dev/null
