---
# See: <https://opencode.ai/docs/github/>
# Note: Keep keys and envs in alphabetical order.
name: OpenCode Review
on:
  issue_comment:
    types:
      - created
  pull_request_review_comment:
    types:
      - created
  pull_request_target:
    types:
      - opened
      - synchronize
      - ready_for_review
      - reopened
      - review_requested
  workflow_call:
    inputs:
      additional_prompt:
        default: ''
        description: Additional instructions for the review prompt
        required: false
        type: string
      agent:
        default: build
        description: Agent to use.
        required: false
        type: string
      model:
        default: opencode/claude-opus-4-5
        description: Model to use for OpenCode
        required: false
        type: string
      pr_number:
        description: Pull request number for workflow_call triggers
        required: true
        type: number
      prompt:
        default: pr-review
        description: Prompt template name from .github/prompts (without extension)
        required: false
        type: string
  workflow_dispatch:
    inputs:
      additional_prompt:
        default: ''
        description: Additional instructions for the review prompt
        required: false
        type: string
      agent:
        default: build
        description: Agent to use.
        options:
          - build
          - compaction
          - plan
          - summary
          - title
        required: false
        type: choice
      model:
        default: opencode/claude-opus-4-5
        description: Model to use for OpenCode
        options:
          - opencode/big-pickle
          - opencode/claude-3-5-haiku
          - opencode/claude-haiku-4-5
          - opencode/claude-opus-4-1
          - opencode/claude-opus-4-5
          - opencode/claude-sonnet-4
          - opencode/claude-sonnet-4-5
          - opencode/gemini-3-flash
          - opencode/gemini-3-pro
          - opencode/glm-4.6
          - opencode/glm-4.7-free
          - opencode/gpt-5
          - opencode/gpt-5-codex
          - opencode/gpt-5-nano
          - opencode/gpt-5.1
          - opencode/gpt-5.1-codex
          - opencode/gpt-5.1-codex-max
          - opencode/gpt-5.1-codex-mini
          - opencode/gpt-5.2
          - opencode/gpt-5.2-codex
          - opencode/grok-code
          - opencode/kimi-k2
          - opencode/kimi-k2-thinking
          - opencode/minimax-m2.1-free
          - opencode/qwen3-coder
        required: false
        type: choice
      pr_number:
        description: Pull request number for manual workflow execution
        required: true
        type: number
      prompt:
        default: pr-review
        description: Prompt template name from .github/prompts (without extension)
        options:
          - pr-review
        required: false
        type: choice
jobs:
  opencode-review:
    # Run automatically for PRs, or when an OWNER/MEMBER adds a `/review` comment on a PR.
    if: |
      (
        github.event_name == 'pull_request_target' &&
        contains(fromJson('["COLLABORATOR","MEMBER","OWNER"]'), github.event.pull_request.author_association)
      ) || (
        github.event_name == 'issue_comment' &&
        github.event.issue.pull_request &&
        startsWith(github.event.comment.body, '/review') &&
        !endsWith(github.actor, '[bot]') &&
        contains(fromJson('["COLLABORATOR","MEMBER","OWNER"]'), github.event.comment.author_association)
      ) || (
        github.event_name == 'pull_request_review_comment' &&
        startsWith(github.event.comment.body, '/review') &&
        !endsWith(github.actor, '[bot]') &&
        contains(fromJson('["COLLABORATOR","MEMBER","OWNER"]'), github.event.comment.author_association)
      ) ||
      (github.event_name == 'workflow_call' || github.event_name == 'workflow_dispatch')
    name: OpenCode Review
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write  # Needed so opencode can request an OIDC token for GitHub API calls
      issues: read
      pull-requests: write
    steps:
      - name: Get PR number
        id: pr-number
        run: |
          if [ "${{ github.event_name }}" = "workflow_call" ] || [ "${{ github.event_name }}" = "workflow_dispatch" ];
          then
            echo "number=${{ inputs.pr_number }}" >> "$GITHUB_OUTPUT"
          elif [ "${{ github.event_name }}" = "pull_request_target" ] || \
               [ "${{ github.event_name }}" = "pull_request_review_comment" ]; then
            echo "number=${{ github.event.pull_request.number }}" >> "$GITHUB_OUTPUT"
          else
            echo "number=${{ github.event.issue.number }}" >> "$GITHUB_OUTPUT"
          fi
      - name: Get PR details
        id: pr-details
        run: |
          gh api "/repos/${{ github.repository }}/pulls/${{ steps.pr-number.outputs.number }}" > pr_data.json
          gh pr view "${{ steps.pr-number.outputs.number }}" --repo "${{ github.repository }}" \
            --json files > pr_files.json
          sanitized_title=$(jq -r '.title
            | gsub("[\u0000-\u0008\u000B-\u001F\u007F]";"")
            | gsub("\r\n|\r|\n";" ")
            | gsub("&";"&amp;")
            | gsub("<";"&lt;")
            | gsub(">";"&gt;")' pr_data.json)
          echo "title=${sanitized_title}" >> "$GITHUB_OUTPUT"
          echo "sha=$(jq -r .head.sha pr_data.json)" >> "$GITHUB_OUTPUT"
          files_json=$(jq -c '.files | map(.path)' pr_files.json)
          echo "files=${files_json}" >> "$GITHUB_OUTPUT"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - uses: actions/checkout@v6
        with:
          fetch-depth: 1
          persist-credentials: false
      - name: Load review prompt
        id: load-prompt
        env:
          PROMPT_INPUT: ${{ inputs.prompt }}
        run: |
          set -euo pipefail
          prompt_name="${PROMPT_INPUT:-pr-review}"
          [[ "$prompt_name" =~ ^[a-z0-9-]+$ ]] || { echo "Invalid prompt: $prompt_name"; exit 1; }
          prompt_file=".github/prompts/$prompt_name.prompt.md"
          [ -f "$prompt_file" ] || { echo "Missing prompt: $prompt_file"; exit 1; }
          { echo 'prompt<<EOF'; cat "$prompt_file"; echo 'EOF'; } >> "$GITHUB_OUTPUT"
      - uses: anomalyco/opencode/github@latest
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OPENCODE_API_KEY: ${{ secrets.OPENCODE_API_KEY }}
          OPENCODE_PERMISSION: |-
            { "bash": {  "*": "deny", "gh*": "allow", "gh pr review*": "deny" } }
        with:
          agent: ${{ inputs.agent || 'build' }}
          # See: <https://opencode.ai/docs/models/>
          model: >-
            ${{ (github.event_name == 'workflow_call' || github.event_name == 'workflow_dispatch')
            && inputs.model || 'opencode/claude-opus-4-5' }}
          prompt: |-
            Pull request needs to be reviewed in the context of the following repository:
            <repo>
            ${{ github.repository }}
            </repo>
            <pr-number>
            ${{ steps.pr-number.outputs.number }}
            </pr-number>
            <pr-files-json>
            ${{ steps.pr-details.outputs.files }}
            </pr-files-json>
            <pr-title>
            ${{ steps.pr-details.outputs.title }}
            </pr-title>
            <pr-sha>
            ${{ steps.pr-details.outputs.sha }}
            </pr-sha>
            ${{ steps.load-prompt.outputs.prompt }}
            ${{ inputs.additional_prompt && format('\nAdditional instructions:\n{0}', inputs.additional_prompt) || '' }}
      - name: Show OpenCode log on failure
        if: failure()
        run: |-
          tail -n 100 ~/.local/share/opencode/log/*.log 2>/dev/null
