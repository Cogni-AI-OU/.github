---
# See: <https://opencode.ai/docs/github/>
# Note: Keep keys and envs in alphabetical order.
name: opencode-review

on:
  pull_request:
    types: [opened, synchronize, ready_for_review, reopened, review_requested]

jobs:
  review:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
      pull-requests: read
      issues: read
    steps:
      - uses: actions/checkout@v6
        with:
          persist-credentials: false
      - uses: anomalyco/opencode/github@latest
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        with:
          # See: <https://opencode.ai/docs/models/>
          model: anthropic/claude-sonnet-4-20250514
          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ github.event.pull_request.number }}

            Review this pull request:
            - Check for code quality issues
            - In case the latest CI build fails, identify the main cause of failure.
            - Look for potential bugs, logic errors, or incorrect behavior
            - Missing error handling
            - Performance issues with measurable impact
            - Security vulnerabilities

            Guidelines:
            - Be concise. Only comment on high-value issues, not style preferences.
            - Skip praise, summaries, and obvious observations.
            - If no significant issues exist, state that briefly.
            - Reference AGENTS.md if present for project conventions.
            - Suggest committable improvements for simple fixes.
