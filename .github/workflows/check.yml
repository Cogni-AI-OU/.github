---
name: Check

# yamllint disable-line rule:truthy
on:
  pull_request:
  push:
  schedule:
    - cron: '0 0 * * 1'  # Run every Monday at 00:00 UTC
  workflow_call:

jobs:
  actionlint:
    name: actionlint
    runs-on: ubuntu-latest
    permissions:
      contents: read
      models: read  # Required for AI inference
    steps:
      - uses: actions/checkout@v5
      - uses: reviewdog/action-actionlint@v1
        id: actionlint
        continue-on-error: true
      - name: Add Problem Matcher for actionlint
        run: |
          echo "::add-matcher::.github/actionlint-matcher.json"
        shell: bash
      - name: Capture actionlint output on failure
        if: steps.actionlint.outcome == 'failure'
        id: capture-logs
        run: |
          echo "logs<<EOF" >> "$GITHUB_OUTPUT"
          actionlint 2>&1 | head -100 >> "$GITHUB_OUTPUT" || true
          echo "EOF" >> "$GITHUB_OUTPUT"
        shell: bash
      - name: AI Analysis of Build Failure
        if: steps.actionlint.outcome == 'failure'
        id: ai-analysis
        uses: actions/ai-inference@v1
        with:
          model: gpt-4o-mini
          prompt: |
            Analyze this GitHub Actions workflow lint failure and identify the main cause.
            Provide a concise analysis with:
            1. The specific file(s) and line(s) causing the issue
            2. What the error means
            3. How to fix it

            Error output:
            ${{ steps.capture-logs.outputs.logs }}
      - name: Write AI Analysis to Summary
        if: steps.actionlint.outcome == 'failure'
        run: |
          {
            echo "## AI Analysis of actionlint Failure"
            echo ""
            echo "${{ steps.ai-analysis.outputs.response }}"
          } >> "$GITHUB_STEP_SUMMARY"
        shell: bash
      - name: Fail job if actionlint failed
        if: steps.actionlint.outcome == 'failure'
        run: exit 1
        shell: bash
  pre-commit:
    name: Pre-commit
    runs-on: ubuntu-latest
    permissions:
      contents: read
      models: read  # Required for AI inference
    steps:
      - uses: actions/checkout@v5
      - uses: actions/cache@v4
        with:
          path: ~/.cache/pre-commit
          key: pre-commit|${{ hashFiles('.pre-commit-config.yaml') }}
          restore-keys: |
            pre-commit|
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - uses: pre-commit/action@v3.0.1
        id: pre-commit
        continue-on-error: true
      - name: Capture pre-commit output on failure
        if: steps.pre-commit.outcome == 'failure'
        id: capture-logs
        run: |
          echo "logs<<EOF" >> "$GITHUB_OUTPUT"
          pre-commit run --all-files 2>&1 | head -100 >> "$GITHUB_OUTPUT" || true
          echo "EOF" >> "$GITHUB_OUTPUT"
        shell: bash
      - name: AI Analysis of Build Failure
        if: steps.pre-commit.outcome == 'failure'
        id: ai-analysis
        uses: actions/ai-inference@v1
        with:
          model: gpt-4o-mini
          prompt: |
            Analyze this pre-commit hook failure and identify the main cause.
            Provide a concise analysis with:
            1. Which hook(s) failed and on which file(s)
            2. What the error means
            3. How to fix it (e.g., specific commands to run or changes to make)

            Use GitHub workflow annotation format for specific issues:
            ::error file=<path>,line=<num>::<message>

            Error output:
            ${{ steps.capture-logs.outputs.logs }}
      - name: Write AI Analysis to Summary
        if: steps.pre-commit.outcome == 'failure'
        run: |
          {
            echo "## AI Analysis of Pre-commit Failure"
            echo ""
            echo "${{ steps.ai-analysis.outputs.response }}"
          } >> "$GITHUB_STEP_SUMMARY"
        shell: bash
      - name: Fail job if pre-commit failed
        if: steps.pre-commit.outcome == 'failure'
        run: exit 1
        shell: bash
