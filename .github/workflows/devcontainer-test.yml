---
name: Test DevContainer

# yamllint disable-line rule:truthy
on:
  pull_request:
    paths:
      - '.devcontainer/**'
      - '.github/workflows/devcontainer-test.yml'
  push:
    branches: [main]
    paths:
      - '.devcontainer/**'
      - '.github/workflows/devcontainer-test.yml'
  workflow_dispatch:

jobs:
  test-devcontainer:
    name: Test DevContainer Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Set lowercase repository name
        id: repo
        run: echo "name=$(echo \"${{ github.repository }}\" | tr '[:upper:]' '[:lower:]')" >> "$GITHUB_OUTPUT"

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and test dev container
        uses: devcontainers/ci@v0.3
        with:
          imageName: ghcr.io/${{ steps.repo.outputs.name }}/devcontainer
          cacheFrom: ghcr.io/${{ steps.repo.outputs.name }}/devcontainer
          push: filter
          refFilterForPush: refs/heads/main
          runCmd: |
            echo "Testing devcontainer build..."

            if command -v pre-commit &> /dev/null; then
              echo "✓ pre-commit is installed"
              pre-commit --version
            else
              echo "✗ pre-commit is not installed"
              exit 1
            fi

            if command -v python3 &> /dev/null; then
              echo "✓ python3 is installed"
              python3 --version
            else
              echo "✗ python3 is not installed"
              exit 1
            fi

            if command -v pip &> /dev/null; then
              echo "✓ pip is installed"
              pip --version
            else
              echo "✗ pip is not installed"
              exit 1
            fi

            if command -v node &> /dev/null; then
              echo "✓ node is installed"
              node --version
            else
              echo "✗ node is not installed"
              exit 1
            fi

            if command -v npm &> /dev/null; then
              echo "✓ npm is installed"
              npm --version
            else
              echo "✗ npm is not installed"
              exit 1
            fi

            if command -v make &> /dev/null; then
              echo "✓ make is installed"
              make --version | head -n 1
            else
              echo "✗ make is not installed"
              exit 1
            fi

            if command -v rg &> /dev/null; then
              echo "✓ ripgrep is installed"
              rg --version
            else
              echo "✗ ripgrep is not installed"
              exit 1
            fi

            if command -v docker &> /dev/null; then
              echo "✓ docker is installed"
              docker --version
            else
              echo "✗ docker is not installed"
              exit 1
            fi

            if command -v actionlint &> /dev/null; then
              echo "✓ actionlint is installed"
              actionlint --version
            else
              echo "✗ actionlint is not installed"
              exit 1
            fi

            if command -v gh &> /dev/null; then
              echo "✓ gh CLI is installed"
              gh --version
            else
              echo "✗ gh CLI is not installed"
              exit 1
            fi

            if command -v ansible &> /dev/null; then
              echo "✓ ansible is installed"
              ansible --version | head -n 1
            else
              echo "✗ ansible is not installed"
              exit 1
            fi

            echo "Checking Python packages from requirements.txt..."
            pip list \
              | grep -qE "ansible|ansible-lint|docker|molecule|pre-commit|uv" \
              || { echo "Required Python packages are missing"; exit 1; }

            if [ -d ".git/hooks" ] && [ -f ".git/hooks/pre-commit" ]; then
              echo "✓ pre-commit hooks are installed"
            else
              echo "✗ pre-commit hooks not installed (expected in CI)"
            fi

            echo "All DevContainer tests passed successfully! ✓"
