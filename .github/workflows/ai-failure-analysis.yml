---
name: AI Failure Analysis

on:
  workflow_call:
    inputs:
      job-name:
        description: 'Name of the job that failed (for display purposes)'
        required: true
        type: string
      error-logs:
        description: 'Error logs from the failed job'
        required: true
        type: string
      analysis-prompt:
        description: 'Custom prompt for AI analysis'
        required: false
        type: string
        default: |
          Analyze this build failure and identify the main cause.
          Provide a concise analysis with:
          1. The specific file(s) and line(s) causing the issue
          2. What the error means
          3. How to fix it (e.g., specific commands to run or changes to make)

          Use GitHub workflow annotation format for specific issues:
          ::error file=<path>,line=<num>::<message>
      model:
        description: 'AI model to use for analysis'
        required: false
        type: string
        default: 'grok-code-fast-1'

jobs:
  analyze:
    name: AI Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 5
    permissions:
      contents: read
      models: read  # Required for AI inference
    steps:
      - name: AI Analysis of Build Failure
        id: ai-analysis
        continue-on-error: true
        uses: actions/ai-inference@v1
        with:
          model: ${{ inputs.model }}
          prompt: |
            ${{ inputs.analysis-prompt }}

            Error output:
            ${{ inputs.error-logs }}
      - name: Write AI Analysis to Summary
        if: steps.ai-analysis.outcome == 'success'
        run: |
          {
            echo "## ü§ñ AI Analysis of ${{ inputs.job-name }} Failure"
            echo ""
            echo "**Model:** \`${{ inputs.model }}\`"
            echo ""
            echo "${{ steps.ai-analysis.outputs.response }}"
            echo ""
            echo "---"
            echo "*AI-generated analysis may not be perfect. Please verify suggestions before applying.*"
          } >> "$GITHUB_STEP_SUMMARY"
        shell: bash
      - name: Report AI Analysis Failure
        if: steps.ai-analysis.outcome == 'failure'
        run: |
          {
            echo "## ‚ö†Ô∏è AI Analysis of ${{ inputs.job-name }} Failure"
            echo ""
            echo "AI analysis failed to complete. Please review the error logs manually."
            echo ""
            echo "<details>"
            echo "<summary>Error Logs</summary>"
            echo ""
            echo "\`\`\`"
            echo "${{ inputs.error-logs }}"
            echo "\`\`\`"
            echo ""
            echo "</details>"
          } >> "$GITHUB_STEP_SUMMARY"
        shell: bash
